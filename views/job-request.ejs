<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confirm Your Application | Helply</title>
  <link rel="stylesheet" href="/job/styles.css"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <div class="logo">HELPLY</div>
      <nav class="nav-links">
        <a href="/index">Home</a>
        <a href="/job-details">Jobs</a>
        <a href="/hire">Post a Job</a>
      </nav>
    </div>
  </header>

  <!-- Job Request Form -->
  <div class="job-request-container">
    <h2>Apply for: <%= job.Title %></h2>
    
    <div class="user-info">
      <p>You are applying as:</p>
      <p><strong>Full Name:</strong> <%= user.Name %></p>
      <p><strong>Email:</strong> <%= user.email %></p>
      <!-- NOTE: Worker's phone number is retrieved by the employer via DB JOIN on acceptance -->
      <p><small>Not you? <a href="/signin">Log in with a different account</a> or <a href="/profile">edit your profile (e.g., add phone number)</a>.</small></p>
    </div>

    <form id="jobRequestForm" enctype="multipart/form-data">
      <!-- Hidden input to send job ID to the API -->
      <input type="hidden" id="jobId" name="jobId" value="<%= job.Job_ID %>">
      
      <label for="resume">Upload Resume (Optional)</label>
      <p>Your resume from your profile will be used if you don't upload a new one.</p>
      <input type="file" id="resume" name="resume">

      <label for="message">Cover Letter / Message</label>
      <textarea id="message" name="message" rows="6" placeholder="Why are you a great fit for this role?" required></textarea>

      <button type="submit">Confirm and Submit Application</button>
    </form>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Helply. All rights reserved.</p>
  </footer>

  <script>
    document.getElementById('jobRequestForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const jobId = document.getElementById('jobId').value;
      const coverLetter = document.getElementById('message').value;

      // Prepare submission data
      const applicationData = {
          jobId: jobId,
          coverLetter: coverLetter
      };

      const btn = e.target.querySelector('button');
      btn.textContent = 'Submitting...';
      btn.disabled = true;

      // Fetch call to POST the application to the backend
      fetch('/api/applications', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(applicationData)
      })
      .then(response => {
          if (!response.ok) {
              return response.json().then(err => { throw new Error(err.error || 'Failed to submit application.') });
          }
          return response.json();
      })
      .then(result => {
          btn.textContent = 'Application Submitted!';
          btn.style.backgroundColor = '#2a9d8f'; // Success color
          // IMPORTANT: Use custom UI or redirect instead of alert
          setTimeout(() => {
              window.location.href = '/worker_dashboard'; // Redirect to worker dashboard
          }, 1000);
      })
      .catch(error => {
          console.error("Application submission failed:", error);
          btn.textContent = 'Error! Try Again.';
          btn.style.backgroundColor = '#e63946'; // Error color
          btn.disabled = false;
          // IMPORTANT: Use custom UI alert instead of native alert()
          alert(`Submission failed: ${error.message}`);
      });
    });
  </script>

</body>
</html>
